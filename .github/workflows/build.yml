name: Flutter Build All Platforms

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
            build-command: flutter build apk --release --split-per-abi
            artifact-paths: build/app/outputs/apk/release/*.apk

          - platform: ios
            os: macos-latest
            build-command: |
              flutter build ios --release --no-codesign
              mkdir -p build/ios/ipa/Payload
              cp -R build/ios/iphoneos/Runner.app build/ios/ipa/Payload/
              cd build/ios/ipa
              zip -r ios-build.zip Payload/
              mv ios-build.zip ios-build.ipa
              rm -rf Payload
            artifact-paths: build/ios/ipa/*.ipa

          - platform: windows
            os: windows-latest
            build-command: flutter build windows --release
            artifact-paths: windows-build.zip

          - platform: macos
            os: macos-latest
            build-command: flutter build macos --release
            artifact-paths: macos-build.zip

          - platform: linux
            os: ubuntu-latest
            build-command: flutter build linux --release
            artifact-paths: linux-build.zip

    steps:
      - name: Clone repo
        run: |
          git clone https://cnb.cool/wget/i/synclipboard temp_repo
          if ($Env:RUNNER_OS -eq "Windows") {
              Get-ChildItem -Path temp_repo -Recurse | Move-Item -Destination . -Force
              Remove-Item -Path temp_repo -Recurse -Force
          } else {
              mv temp_repo/* .
              mv temp_repo/.* . 2>/dev/null || true
              rm -rf temp_repo
          }
          Get-ChildItem || ls -l
        shell: pwsh

      - name: Setup Java
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.38.8
          cache: true

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake git libkeybinder-3.0-dev libappindicator3-dev \
            libgtk-3-dev liblzma-dev ninja-build pkg-config llvm lld zip

      - name: Install iOS build dependencies
        if: matrix.platform == 'ios'
        run: |
          brew install xcodegen || true
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          sudo gem install cocoapods -v 1.15.2

      - name: Flutter pub get
        run: flutter pub get

      - name: Android signing
        if: matrix.platform == 'android'
        env:
          FLUTTER_ANDROID_KEYSTORE_BASE64: ${{ secrets.FLUTTER_ANDROID_KEYSTORE_BASE64 }}
          FLUTTER_KEYSTORE_PASSWORD: ${{ secrets.FLUTTER_KEYSTORE_PASSWORD }}
          FLUTTER_KEY_ALIAS: ${{ secrets.FLUTTER_KEY_ALIAS }}
        run: |
          echo "$FLUTTER_ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/cnbclpboard.jks
          cat > android/key.properties << EOF
          storePassword=$FLUTTER_KEYSTORE_PASSWORD
          keyPassword=$FLUTTER_KEYSTORE_PASSWORD
          keyAlias=$FLUTTER_KEY_ALIAS
          storeFile=cnbclpboard.jks
          EOF

      - name: Build
        run: ${{ matrix.build-command }}
        continue-on-error: false

      - name: Zip Windows
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath windows-build.zip -Force
          Get-ChildItem windows-build.zip

      - name: Zip Linux
        if: matrix.platform == 'linux'
        run: |
          zip -r linux-build.zip build/linux/x64/release/bundle/*
          ls -lh linux-build.zip

      - name: Zip macOS
        if: matrix.platform == 'macos'
        run: |
          zip -r macos-build.zip build/macos/Build/Products/Release/*.app
          ls -lh macos-build.zip

      - name: Verify build artifacts
        run: |
          if ($Env:RUNNER_OS -eq "Windows") {
              Get-ChildItem -Name *.zip -ErrorAction SilentlyContinue
          } else {
              ls -l *.zip || true
              ls -l build/ios/ipa/*.ipa || true
          }
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build-${{ matrix.platform }}
          path: ${{ matrix.artifact-paths }}
          retention-days: 7

  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: List artifacts
        run: ls -R release_artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: weekly-build-${{ github.run_id }}
          name: Weekly Build ${{ github.run_id }}
          files: release_artifacts/**/*
          generate_release_notes: true
