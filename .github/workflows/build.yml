name: Flutter Build All Platforms

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
            build-command: flutter build apk --release --split-per-abi
            artifact-paths: build/app/outputs/apk/release/*.apk
          - platform: ios
            os: macos-latest
            build-command: |
              flutter build ios --release --no-codesign
              xcodebuild -exportArchive -archivePath build/ios/archive/Runner.xcarchive -exportPath build/ios/ipa -exportOptionsPlist <(cat <<EOF
              <?xml version="1.0" encoding="UTF-8"?>
              <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
              <plist version="1.0">
              <dict>
                <key>method</key>
                <string>ad-hoc</string>
                <key>signingStyle</key>
                <string>manual</string>
                <key>stripSwiftSymbols</key>
                <true/>
                <key>cnb</key>
                <string>cnb</string>
                <key>compileBitcode</key>
                <false/>
              </dict>
              </plist>
              EOF
              ) -allowProvisioningUpdates
            artifact-paths: build/ios/ipa/*.ipa
          # - platform: web
          #   os: ubuntu-latest
          #   build-command: flutter build web --release
          #   artifact-paths: build/web/**/*
          - platform: windows
            os: windows-latest
            build-command: flutter build windows --release
            artifact-paths: windows-build.zip
          - platform: macos
            os: macos-latest
            build-command: flutter build macos --release
            artifact-paths: macos-build.zip
          - platform: linux
            os: ubuntu-latest
            build-command: flutter build linux --release
            artifact-paths: linux-build.zip

    steps:
      - name: 克隆指定远程仓库代码
        shell: bash
        run: |
          git clone https://cnb.cool/wget/i/synclipboard temp_repo
          if [[ "$(uname -s)" == "Linux" || "$(uname -s)" == "Darwin" ]]; then
            mv temp_repo/* .
            mv temp_repo/.* . 2>/dev/null || true
          else
            robocopy temp_repo . /E /MOV
            rmdir /S /Q temp_repo
          fi
          ls -l || dir

      - name: 设置Java环境
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 设置Flutter环境
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.38.8
      - run: flutter --version

      - name: 安装Linux构建依赖
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            git \
            gtk+-3.0 \
            libgtk-3-dev \
            liblzma-dev \
            ninja-build \
            pkg-config \
            llvm \
            lld \
            zip

      - name: 安装依赖
        run: flutter pub get

      - name: 创建签名配置
        if: matrix.platform == 'android'
        env:
          FLUTTER_ANDROID_KEYSTORE_BASE64: ${{ secrets.FLUTTER_ANDROID_KEYSTORE_BASE64 }}
          FLUTTER_KEYSTORE_PASSWORD: ${{ secrets.FLUTTER_KEYSTORE_PASSWORD }}
          FLUTTER_KEY_ALIAS: ${{ secrets.FLUTTER_KEY_ALIAS }}
        run: |
          echo "$FLUTTER_ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/cnbclpboard.jks
          cat > android/key.properties << EOF
          storePassword=$FLUTTER_KEYSTORE_PASSWORD
          keyPassword=$FLUTTER_KEYSTORE_PASSWORD
          keyAlias=$FLUTTER_KEY_ALIAS
          storeFile=cnbclpboard.jks
          EOF

      - name: 构建对应平台产物
        run: ${{ matrix.build-command }}
      
      - name: 压缩Windows产物为ZIP
        if: matrix.platform == 'windows'
        working-directory: build/windows/x64/runner/Release
        run: Compress-Archive -Path .\* -DestinationPath ..\..\..\..\windows-build.zip

      - name: 压缩Linux产物为ZIP
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update && sudo apt-get install -y zip
          cd build/linux/x64/release/bundle
          zip -r ../../../../linux-build.zip .

      - name: 压缩macOS产物为ZIP
        if: matrix.platform == 'macos'
        run: |
          cd build/macos/Build/Products/Release/
          zip -r ../../../../../macos-build.zip *.app

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build-${{ matrix.platform }}
          path: ${{ matrix.artifact-paths }}
          retention-days: 7

      - name: 收集所有产物用于Release
        if: matrix.platform == 'android'
        run: |
          mkdir -p release_artifacts
          cp build/app/outputs/apk/release/*.apk release_artifacts/
          gh run download ${{ github.run_id }} --name flutter-build-ios --dir release_artifacts
          gh run download ${{ github.run_id }} --name flutter-build-windows --dir release_artifacts
          gh run download ${{ github.run_id }} --name flutter-build-macos --dir release_artifacts
          gh run download ${{ github.run_id }} --name flutter-build-linux --dir release_artifacts
        env:
          GH_TOKEN: ${{ github.token }}

      - name: 创建GitHub Release
        if: matrix.platform == 'android'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: daily-build-${{ github.run_id }}
          name: Daily Build ${{ github.run_id }}
          files: release_artifacts/*
          generate_release_notes: true
