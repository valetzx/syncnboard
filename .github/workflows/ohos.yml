name: Build HarmonyOS (OHOS)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  OHOS_SDK_VERSION: "12"
  BUNDLE_NAME: "cool.cnb.syncnboard"

jobs:
  build-ohos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clone synclipboard ohos branch
        run: |
          git clone -b ohos https://cnb.cool/wget/i/synclipboard.git temp_synclipboard
          mv temp_synclipboard/* $GITHUB_WORKSPACE/
          mv temp_synclipboard/.* $GITHUB_WORKSPACE/ 2>/dev/null || true
          rm -rf temp_synclipboard
          ls -la $GITHUB_WORKSPACE

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Get Flutter dependencies
        run: flutter pub get
        working-directory: synclipboard

      - name: Setup OHPM (OpenHarmony Package Manager)
        run: |
          curl -L "https://repo.harmonyos.com/npm/ohpm-cli-1.5.2.tgz" -o ohpm-cli.tgz
          tar -xzf ohpm-cli.tgz
          sudo mv package/bin/ohpm /usr/local/bin/
          ohpm --version

      - name: Setup Hvigor build tool
        run: |
          npm install -g @ohos/hvigor
          hvigor --version

      - name: Download HarmonyOS SDK
        run: |
          mkdir -p $HOME/ohos-sdk
          curl -L "https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_9_16/e2/r3/609126a99d6441f4a80c16fa9ad993d5/ao1ZesO8Rk2Lx3sWvYHyyQ/command-line-tools-linux-x64-5.0.5.401.zip" -o cmdline-tools.zip || true
          
          if [ -f cmdline-tools.zip ]; then
            unzip -q cmdline-tools.zip -d $HOME/ohos-sdk || true
          fi
          
          echo "OHOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "OHOS_SDK_ROOT=$HOME/ohos-sdk" >> $GITHUB_ENV

      - name: Install OHOS project dependencies
        run: |
          cd synclipboard/ohos
          ohpm install

      - name: Build HAP (HarmonyOS Ability Package)
        run: |
          cd synclipboard/ohos
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor assembleHap --mode release -p product=default
          else
            hvigor assembleHap --mode debug -p product=default
          fi

      - name: Build APP (HarmonyOS Application Package)
        run: |
          cd synclipboard/ohos
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor assembleApp --mode release -p product=default
          else
            hvigor assembleApp --mode debug -p product=default
          fi

      - name: List build outputs
        run: |
          echo "=== Build Outputs ==="
          find synclipboard/ohos -name "*.hap" -o -name "*.app" 2>/dev/null || true
          ls -la synclipboard/ohos/entry/build/default/outputs/default/ 2>/dev/null || true

      - name: Upload HAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-hap
          path: |
            synclipboard/ohos/entry/build/default/outputs/default/*.hap
          retention-days: 30

      - name: Upload APP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-app
          path: |
            synclipboard/ohos/build/outputs/default/*.app
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            synclipboard/ohos/entry/build/default/outputs/default/*.hap
            synclipboard/ohos/build/outputs/default/*.app
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-flutter-ohos:
    runs-on: ubuntu-latest
    needs: build-ohos
    if: ${{ false }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter with OHOS support
        run: |
          git clone https://github.com/nickvdyck/Flutter-OHOS.git $HOME/flutter-ohos || true
          
      - name: Build Flutter for OHOS
        run: |
          cd synclipboard
          # flutter build ohos --release
          echo "Flutter OHOS build requires custom Flutter SDK with OHOS support"
