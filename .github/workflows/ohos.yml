name: Build OHOS HAP

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'synclipboard/**'
      - '.github/workflows/build-ohos.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'synclipboard/**'
      - '.github/workflows/build-ohos.yml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  FLUTTER_VERSION: '3.22.0'
  OHOS_SDK_VERSION: '12'

jobs:
  build-hap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 新增步骤：克隆指定仓库的 ohos2 分支到 synclipboard 目录
      - name: Clone synclipboard (ohos2 branch)
        run: |
          # 删除原有 synclipboard 目录（如果存在），确保使用指定仓库的代码
          rm -rf synclipboard
          # 克隆指定仓库的 ohos2 分支到 synclipboard 目录
          git clone -b ohos2 https://cnb.cool/wget/i/synclipboard synclipboard
          # 验证克隆结果
          if [ ! -d "synclipboard" ]; then
            echo "Failed to clone synclipboard repository"
            exit 1
          fi
          echo "Successfully cloned synclipboard (ohos2 branch)"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup OHOS SDK
        run: |
          echo "Setting up OHOS SDK..."
          mkdir -p $HOME/ohos-sdk
          # 下载 OHOS SDK (实际使用时需要替换为官方下载链接)
          # wget -q https://repo.huaweicloud.com/openharmony/os-cli/ohos-sdk-linux.tar.gz -O ohos-sdk.tar.gz
          # tar -xzf ohos-sdk.tar.gz -C $HOME/ohos-sdk
          echo "OHOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "OHOS_SDK_ROOT=$HOME/ohos-sdk" >> $GITHUB_ENV

      - name: Setup Hvigor
        run: |
          echo "Setting up Hvigor build tool..."
          npm install -g @ohos/hvigor

      - name: Get Flutter dependencies
        working-directory: synclipboard
        run: |
          flutter pub get

      - name: Configure Flutter for OHOS
        working-directory: synclipboard
        run: |
          # 确保 ohos 目录存在
          if [ ! -d "ohos" ]; then
            echo "Creating ohos directory structure..."
            flutter create --platforms=ohos .
          fi

      - name: Build OHOS HAP (Debug)
        if: github.event.inputs.build_type != 'release'
        working-directory: synclipboard
        run: |
          flutter build hap --debug

      - name: Build OHOS HAP (Release)
        if: github.event.inputs.build_type == 'release'
        working-directory: synclipboard
        run: |
          flutter build hap --release

      - name: Find HAP files
        id: find_hap
        working-directory: synclipboard
        run: |
          HAP_FILE=$(find build -name "*.hap" -type f | head -n 1)
          if [ -n "$HAP_FILE" ]; then
            echo "hap_path=$HAP_FILE" >> $GITHUB_OUTPUT
            echo "hap_name=$(basename $HAP_FILE)" >> $GITHUB_OUTPUT
          else
            echo "No HAP file found"
            exit 1
          fi

      - name: Upload HAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-${{ github.event.inputs.build_type || 'debug' }}
          path: synclipboard/${{ steps.find_hap.outputs.hap_path }}
          retention-days: 30

      - name: Create Release
        if: github.event.inputs.build_type == 'release' && github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          files: synclipboard/${{ steps.find_hap.outputs.hap_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 简化版构建 - 使用预配置的 OHOS 环境
  build-hap-simple:
    runs-on: self-hosted
    if: false  # 需要配置 self-hosted runner 时启用
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 为简化版也添加克隆步骤
      - name: Clone synclipboard (ohos2 branch)
        run: |
          rm -rf synclipboard
          git clone -b ohos2 https://cnb.cool/wget/i/synclipboard synclipboard
          if [ ! -d "synclipboard" ]; then
            echo "Failed to clone synclipboard repository"
            exit 1
          fi

      - name: Build HAP
        working-directory: synclipboard
        run: |
          flutter pub get
          flutter build hap --release

      - name: Upload HAP
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-release
          path: synclipboard/build/ohos/outputs/*.hap
