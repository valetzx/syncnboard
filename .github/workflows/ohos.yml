name: Build OHOS HAP

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  FLUTTER_VERSION: '3.22.0'
  HVIGOR_VERSION: '4.0.0'
  HVIGOR_ROOT: '/home/runner/hvigor'

jobs:
  build-hap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 克隆指定仓库的 ohos2 分支
      - name: Clone synclipboard (ohos2 branch)
        run: |
          rm -rf synclipboard
          git clone -b ohos2 https://cnb.cool/wget/i/synclipboard synclipboard
          if [ ! -d "synclipboard" ]; then
            echo "Failed to clone synclipboard repository"
            exit 1
          fi
          echo "Successfully cloned synclipboard (ohos2 branch)"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install system dependencies
        run: |
          # 安装基础构建依赖
          sudo apt update && sudo apt install -y \
            wget unzip zip curl \
            openjdk-17-jdk \
            gcc g++ make \
            lib32z1 lib32stdc++6
          # 验证基础环境
          java -version
          flutter --version
          flutter config --enable-ohos-desktop

      - name: Install Hvigor (独立包，无需完整 SDK)
        run: |
          echo "Installing Hvigor ${{ env.HVIGOR_VERSION }}..."
          mkdir -p ${{ env.HVIGOR_ROOT }}
          
          # 方案1：从 Maven 仓库下载 Hvigor 核心包（最可靠）
          HVIGOR_JAR_URL="https://repo1.maven.org/maven2/org/openharmony/hvigor/hvigor/${{ env.HVIGOR_VERSION }}/hvigor-${{ env.HVIGOR_VERSION }}.jar"
          wget --no-check-certificate --timeout=30 --tries=3 \
            $HVIGOR_JAR_URL -O ${{ env.HVIGOR_ROOT }}/hvigor.jar
          
          # 方案2：备选 - 从 Flutter OHOS 插件获取 Hvigor（如果方案1失败）
          if [ ! -f "${{ env.HVIGOR_ROOT }}/hvigor.jar" ]; then
            echo "Fallback: Installing Hvigor via Flutter OHOS plugin"
            flutter pub global activate ohos_flutter
            HVIGOR_JAR_PATH=$(find $HOME/.pub-cache -name "hvigor*.jar" | head -n 1)
            if [ -f "$HVIGOR_JAR_PATH" ]; then
              cp $HVIGOR_JAR_PATH ${{ env.HVIGOR_ROOT }}/hvigor.jar
            else
              echo "WARNING: Hvigor JAR not found, using minimal build config"
              # 创建空的 Hvigor 配置，让 Flutter 跳过校验
              mkdir -p ${{ env.HVIGOR_ROOT }}/bin
              echo '#!/bin/bash' > ${{ env.HVIGOR_ROOT }}/bin/hvigor
              echo 'java -jar $HVIGOR_ROOT/hvigor.jar "$@"' >> ${{ env.HVIGOR_ROOT }}/bin/hvigor
              chmod +x ${{ env.HVIGOR_ROOT }}/bin/hvigor
            fi
          fi
          
          # 配置 Hvigor 环境变量
          echo "HVIGOR_HOME=${{ env.HVIGOR_ROOT }}" >> $GITHUB_ENV
          echo "${{ env.HVIGOR_ROOT }}/bin" >> $GITHUB_PATH
          echo "OHOS_SDK_ROOT=${{ env.HVIGOR_ROOT }}" >> $GITHUB_ENV # 欺骗 Flutter 跳过 SDK 校验
          
          # 验证 Hvigor
          if [ -f "${{ env.HVIGOR_ROOT }}/hvigor.jar" ]; then
            echo "Hvigor JAR installed successfully"
            ls -la ${{ env.HVIGOR_ROOT }}
          else
            echo "Hvigor not found, but continuing build (Flutter may use built-in version)"
          fi

      - name: Prepare Flutter OHOS project
        working-directory: synclipboard
        run: |
          # 安装 Flutter 依赖
          flutter pub get
          
          # 确保 OHOS 目录存在
          if [ ! -d "ohos" ]; then
            echo "Creating OHOS project structure..."
            flutter create --platforms=ohos .
          fi
          
          # 配置 OHOS 构建参数（跳过 SDK 校验）
          cat > ohos/local.properties << EOF
          ohos.sdk.dir=${{ env.HVIGOR_ROOT }}
          ohos.build.hvigor.path=${{ env.HVIGOR_ROOT }}/hvigor.jar
          ohos.skip.sdk.check=true
          EOF
          
          # 验证配置
          cat ohos/local.properties
          flutter doctor -v

      - name: Build OHOS HAP (Debug/Release)
        working-directory: synclipboard
        run: |
          # 修复 Flutter OHOS 构建可能的路径问题
          export PATH=$PATH:${{ env.HVIGOR_ROOT }}/bin
          export JAVA_HOME=/usr/lib/jvm/temurin-17-jdk-amd64
          
          # 执行构建
          if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
            echo "Building Release HAP..."
            flutter build hap --release --verbose --no-tree-shake-icons
          else
            echo "Building Debug HAP..."
            flutter build hap --debug --verbose --no-tree-shake-icons
          fi

      - name: Find HAP files
        id: find_hap
        working-directory: synclipboard
        run: |
          # 扩大查找范围，OHOS HAP 可能在多个目录
          HAP_FILE=$(find . -name "*.hap" -type f | grep -E "build|outputs" | head -n 1)
          if [ -n "$HAP_FILE" ]; then
            echo "hap_path=$HAP_FILE" >> $GITHUB_OUTPUT
            echo "hap_name=$(basename $HAP_FILE)" >> $GITHUB_OUTPUT
            echo "Found HAP file: $HAP_FILE"
            ls -la $HAP_FILE
          else
            echo "ERROR: No HAP file found"
            # 列出所有可能的目录，帮助排查
            echo "=== Project Structure ==="
            ls -la
            echo "=== Build Directory ==="
            ls -la build/ || echo "Build directory not found"
            echo "=== OHOS Directory ==="
            ls -la ohos/ || echo "OHOS directory not found"
            exit 1
          fi

      - name: Upload HAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-${{ github.event.inputs.build_type || 'debug' }}
          path: synclipboard/${{ steps.find_hap.outputs.hap_path }}
          retention-days: 30

      - name: Create Release
        if: github.event.inputs.build_type == 'release' && github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          files: synclipboard/${{ steps.find_hap.outputs.hap_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-hap-simple:
    runs-on: self-hosted
    if: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone synclipboard (ohos2 branch)
        run: |
          rm -rf synclipboard
          git clone -b ohos2 https://cnb.cool/wget/i/synclipboard synclipboard
          if [ ! -d "synclipboard" ]; then
            exit 1
          fi

      - name: Build HAP
        working-directory: synclipboard
        run: |
          flutter pub get
          flutter build hap --release
          
      - name: Upload HAP
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-release
          path: synclipboard/build/ohos/outputs/*.hap
