name: Build HarmonyOS (OHOS)

on:
  push:
    branches:
      - main
      - master
      - 'release/**'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  OHOS_SDK_VERSION: "12"
  BUNDLE_NAME: "cool.cnb.syncnboard"
  OHOS_REPO_URL: "https://cnb.cool/wget/i/synclipboard"
  OHOS_BRANCH: "ohos"

jobs:
  build-ohos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clone OHOS project from external repository
        run: |
          git clone -b ${{ env.OHOS_BRANCH }} ${{ env.OHOS_REPO_URL }} ohos-project
          echo "OHOS_PROJECT_PATH=$GITHUB_WORKSPACE/ohos-project" >> $GITHUB_ENV
          ls -la $GITHUB_WORKSPACE/ohos-project

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup OHPM (OpenHarmony Package Manager)
        run: |
          # 方案1: 通过 npm 安装 ohpm
          npm install -g @ohos/ohpm 2>/dev/null || true
          
          # 方案2: 下载官方命令行工具包
          if ! command -v ohpm &> /dev/null; then
            echo "Installing OHPM from Huawei DevEco..."
            
            # 创建临时目录
            mkdir -p $HOME/ohpm-install
            cd $HOME/ohpm-install
            
            # 下载 DevEco Studio 命令行工具 (包含 ohpm)
            DEVECO_URL="https://update.flutter-dev.cn/harmonyos/tools/deveco-studio-ohos-cli-linux.tar.gz"
            
            curl -L --connect-timeout 30 --max-time 300 "$DEVECO_URL" -o deveco-cli.tar.gz || {
              echo "Primary download failed, trying alternative..."
              # 备用：直接从华为 CDN 获取
              curl -L "https://repo.harmonyos.com/npm/@ohos/ohpm/-/ohpm-1.6.0.tgz" -o ohpm.tgz
              tar -xzf ohpm.tgz 2>/dev/null || true
            }
            
            if [ -f deveco-cli.tar.gz ]; then
              tar -xzf deveco-cli.tar.gz
              # 查找 ohpm 位置
              OHPM_PATH=$(find . -name "ohpm" -type f 2>/dev/null | head -1)
              if [ -n "$OHPM_PATH" ]; then
                chmod +x "$OHPM_PATH"
                sudo cp "$OHPM_PATH" /usr/local/bin/
              fi
            fi
          fi
          
          # 验证安装
          ohpm --version 2>/dev/null || echo "ohpm command ready"
          which ohpm || echo "ohpm location check"

      - name: Cache OHOS dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.ohpm
            **/oh_modules
          key: ${{ runner.os }}-ohos-${{ hashFiles('**/oh-package.json5') }}
          restore-keys: |
            ${{ runner.os }}-ohos-

      - name: Setup Hvigor build tool
        run: |
          npm install -g @ohos/hvigor
          hvigor --version || echo "Hvigor ready"

      - name: Setup HarmonyOS SDK
        run: |
          mkdir -p $HOME/ohos-sdk
          
          # 设置环境变量
          echo "OHOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "OHOS_SDK_ROOT=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "HARMONYOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          
          # 尝试下载 SDK (可选，有些项目需要)
          echo "SDK environment configured"

      - name: Configure OHPM
        run: |
          # 配置 ohpm 仓库
          mkdir -p ~/.ohpm
          cat > ~/.ohpm/.ohpmrc << 'EOF'
          registry=https://repo.harmonyos.com/npm/
          strict-ssl=false
          EOF

      - name: Create local.properties
        run: |
          cd ${{ env.OHOS_PROJECT_PATH }}/ohos 2>/dev/null || cd ${{ env.OHOS_PROJECT_PATH }}
          
          cat > local.properties << EOF
          sdk.dir=$HOME/ohos-sdk
          ohos.sdk.dir=$HOME/ohos-sdk
          nodejs.dir=$(dirname $(which node))
          EOF
          
          cat local.properties

      - name: Install dependencies
        run: |
          # 查找 ohos 目录
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          cd "$OHOS_DIR"
          
          echo "Installing dependencies in: $(pwd)"
          ls -la
          
          # 安装依赖
          ohpm install --all 2>&1 || {
            echo "ohpm install failed, trying with fallback..."
            npm install 2>/dev/null || true
          }

      - name: Build HAP
        run: |
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          cd "$OHOS_DIR"
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          echo "Building HAP: $BUILD_TYPE"
          
          hvigor clean --no-daemon 2>/dev/null || true
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor assembleHap --no-daemon -p buildMode=release 2>&1
          else
            hvigor assembleHap --no-daemon -p buildMode=debug 2>&1
          fi

      - name: Build APP
        run: |
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          cd "$OHOS_DIR"
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          echo "Building APP: $BUILD_TYPE"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor assembleApp --no-daemon -p buildMode=release 2>&1
          else
            hvigor assembleApp --no-daemon -p buildMode=debug 2>&1
          fi

      - name: Collect artifacts
        run: |
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          echo "=== Build Outputs ==="
          find "$OHOS_DIR" -name "*.hap" -o -name "*.app" 2>/dev/null || true
          
          mkdir -p artifacts/hap artifacts/app
          
          find "$OHOS_DIR" -name "*.hap" -exec cp {} artifacts/hap/ \; 2>/dev/null || true
          find "$OHOS_DIR" -name "*.app" -exec cp {} artifacts/app/ \; 2>/dev/null || true
          
          echo "=== Artifacts ==="
          ls -la artifacts/hap/ 2>/dev/null || echo "No HAP artifacts"
          ls -la artifacts/app/ 2>/dev/null || echo "No APP artifacts"

      - name: Upload HAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-hap
          path: artifacts/hap/*.hap
          retention-days: 30
          if-no-files-found: warn

      - name: Upload APP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-app
          path: artifacts/app/*.app
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/hap/*.hap
            artifacts/app/*.app
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
