name: Build HarmonyOS (OHOS)

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  OHOS_SDK_VERSION: "12"
  BUNDLE_NAME: "cool.cnb.syncnboard"
  OHOS_REPO_URL: "https://cnb.cool/wget/i/synclipboard"
  OHOS_BRANCH: "ohos"
  OHOS_NPM_REGISTRY: "https://repo.harmonyos.com/npm/"

jobs:
  build-ohos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clone OHOS project from external repository
        run: |
          git clone -b ${{ env.OHOS_BRANCH }} ${{ env.OHOS_REPO_URL }} ohos-project
          echo "OHOS_PROJECT_PATH=$GITHUB_WORKSPACE/ohos-project" >> $GITHUB_ENV
          ls -la $GITHUB_WORKSPACE/ohos-project

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: ${{ env.OHOS_NPM_REGISTRY }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Configure npm for OHOS
        run: |
          npm config set registry ${{ env.OHOS_NPM_REGISTRY }}
          npm config set strict-ssl false
          npm config delete _authToken
          npm config delete access_token
          npm config list

      - name: Setup OHPM (OpenHarmony Package Manager)
        run: |
          npm install -g @ohos/ohpm || {
            echo "Failed to install ohpm via npm, trying alternative method..."
            mkdir -p $HOME/ohpm-install
            cd $HOME/ohpm-install
            
            DEVECO_URL="https://update.flutter-dev.cn/harmonyos/tools/deveco-studio-ohos-cli-linux.tar.gz"
            
            if curl -L --connect-timeout 30 --max-time 300 "$DEVECO_URL" -o deveco-cli.tar.gz; then
              tar -xzf deveco-cli.tar.gz
              OHPM_PATH=$(find . -name "ohpm" -type f 2>/dev/null | head -1)
              if [ -n "$OHPM_PATH" ]; then
                chmod +x "$OHPM_PATH"
                sudo cp "$OHPM_PATH" /usr/local/bin/
              fi
            else
              echo "Primary download failed, trying alternative CDN..."
              curl -L "https://repo.harmonyos.com/npm/@ohos/ohpm/-/ohpm-1.6.0.tgz" -o ohpm.tgz
              tar -xzf ohpm.tgz
              if [ -d "package/bin" ]; then
                chmod +x package/bin/ohpm
                sudo cp package/bin/ohpm /usr/local/bin/
              fi
            fi
          }
          
          ohpm --version || {
            echo "ohpm installation failed"
            exit 1
          }
          which ohpm

      - name: Cache OHOS dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.ohpm
            **/oh_modules
            ~/.npm
          key: ${{ runner.os }}-ohos-${{ hashFiles('**/oh-package.json5') }}
          restore-keys: |
            ${{ runner.os }}-ohos-

      - name: Setup Hvigor build tool
        run: |
          echo "Installing hvigor from OHOS npm registry..."
          npm install -g @ohos/hvigor || {
            echo "Failed to install hvigor via npm, trying alternative versions..."
            npm install -g @ohos/hvigor@4.0.0 || npm install -g @ohos/hvigor@latest
          }
          
          hvigor --version || {
            echo "Hvigor installation failed"
            npm list -g @ohos/hvigor
            which hvigor
            exit 1
          }

      - name: Setup HarmonyOS SDK
        run: |
          mkdir -p $HOME/ohos-sdk
          
          echo "OHOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "OHOS_SDK_ROOT=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "HARMONYOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          
          echo "PATH=\$PATH:\$HOME/ohos-sdk/tools" >> $GITHUB_ENV

      - name: Configure OHPM
        run: |
          mkdir -p ~/.ohpm
          cat > ~/.ohpm/.ohpmrc << 'EOF'
          registry=https://repo.harmonyos.com/npm/
          strict-ssl=false
          EOF
          
          ohpm config list

      - name: Create local.properties
        run: |
          cd ${{ env.OHOS_PROJECT_PATH }}/ohos 2>/dev/null || cd ${{ env.OHOS_PROJECT_PATH }}
          
          cat > local.properties << EOF
          sdk.dir=$HOME/ohos-sdk
          ohos.sdk.dir=$HOME/ohos-sdk
          nodejs.dir=$(dirname $(which node))
          hvigor.home=$(npm root -g)/@ohos/hvigor
          EOF
          
          cat local.properties

      - name: Install dependencies
        run: |
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          cd "$OHOS_DIR"
          
          echo "Installing dependencies in: $(pwd)"
          ls -la
          
          npm config set registry ${{ env.OHOS_NPM_REGISTRY }}
          
          if [ -f "oh-package.json5" ]; then
            ohpm install --all || {
              echo "ohpm install failed, falling back to npm..."
              npm install
            }
          else
            npm install
          fi

      - name: Build HAP
        run: |
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          cd "$OHOS_DIR"
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          echo "Building HAP: $BUILD_TYPE"
          
          hvigor clean --no-daemon
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor assembleHap --no-daemon -p buildMode=release
          else
            hvigor assembleHap --no-daemon -p buildMode=debug
          fi

      - name: Build APP
        run: |
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          cd "$OHOS_DIR"
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          echo "Building APP: $BUILD_TYPE"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor assembleApp --no-daemon -p buildMode=release
          else
            hvigor assembleApp --no-daemon -p buildMode=debug
          fi

      - name: Collect artifacts
        run: |
          OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}/ohos"
          if [ ! -d "$OHOS_DIR" ]; then
            OHOS_DIR="${{ env.OHOS_PROJECT_PATH }}"
          fi
          
          echo "=== Build Outputs ==="
          find "$OHOS_DIR" -name "*.hap" -o -name "*.app" 2>/dev/null || true
          
          mkdir -p artifacts/hap artifacts/app
          
          find "$OHOS_DIR" -name "*.hap" -exec cp {} artifacts/hap/ \; 2>/dev/null || true
          find "$OHOS_DIR" -name "*.app" -exec cp {} artifacts/app/ \; 2>/dev/null || true
          
          echo "=== Artifacts ==="
          ls -la artifacts/hap/ 2>/dev/null || echo "No HAP artifacts"
          ls -la artifacts/app/ 2>/dev/null || echo "No APP artifacts"

      - name: Upload HAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-hap
          path: artifacts/hap/*.hap
          retention-days: 30
          if-no-files-found: warn

      - name: Upload APP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-app
          path: artifacts/app/*.app
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/hap/*.hap
            artifacts/app/*.app
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
