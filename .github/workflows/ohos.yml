name: Build OHOS HAP

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      branch:
        description: 'Branch to build'
        required: false
        default: 'ohos'
        type: string

env:
  FLUTTER_OHOS_VERSION: '3.7.12-ohos-1.0.4'
  WORK_DIR: ${{ github.workspace }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clone repository
        run: |
          # 确定要构建的分支
          BRANCH="${{ github.event.inputs.branch || 'ohos' }}"
          echo "Building branch: $BRANCH"

          # 克隆指定仓库和分支
          git clone --depth 1 --branch "$BRANCH" \
            https://cnb.cool/wget/i/synclipboard.git "${{ github.workspace }}"

          echo "Working directory: ${{ github.workspace }}"
          ls -la "${{ github.workspace }}"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Flutter OHOS
        id: cache-flutter
        uses: actions/cache@v4
        with:
          path: /tmp/flutter_ohos
          key: flutter-ohos-${{ env.FLUTTER_OHOS_VERSION }}

      - name: Install Flutter OHOS SDK
        if: steps.cache-flutter.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch ${{ env.FLUTTER_OHOS_VERSION }} \
            https://gitee.com/openharmony-sig/flutter_flutter.git /tmp/flutter_ohos
          cd /tmp/flutter_ohos
          git tag ${{ env.FLUTTER_OHOS_VERSION }}

      - name: Setup OHOS SDK directory
        run: |
          mkdir -p $HOME/ohos-sdk/hmscore/toolchains
          mkdir -p $HOME/ohos-sdk/openharmony/toolchains
          mkdir -p $HOME/ohos-tools/bin

          # Create hdc placeholder
          cat > $HOME/ohos-sdk/hmscore/toolchains/hdc << 'EOF'
          #!/bin/bash
          echo "HDC placeholder for CI build"
          EOF
          chmod +x $HOME/ohos-sdk/hmscore/toolchains/hdc
          ln -sf $HOME/ohos-sdk/hmscore/toolchains/hdc $HOME/ohos-sdk/openharmony/toolchains/hdc

          # Create ohpm placeholder
          cat > $HOME/ohos-tools/bin/ohpm << 'EOF'
          #!/bin/bash
          echo "OHPM placeholder"
          EOF
          chmod +x $HOME/ohos-tools/bin/ohpm

          # Create hvigorw placeholder
          cat > $HOME/ohos-tools/bin/hvigorw << 'EOF'
          #!/bin/bash
          echo "Hvigor placeholder"
          EOF
          chmod +x $HOME/ohos-tools/bin/hvigorw

      - name: Configure environment
        run: |
          echo "FLUTTER_OHOS_ROOT=/tmp/flutter_ohos" >> $GITHUB_ENV
          echo "OHOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "/tmp/flutter_ohos/bin" >> $GITHUB_PATH
          echo "$HOME/ohos-tools/bin" >> $GITHUB_PATH

      - name: Get dependencies
        run: |
          cd ${{ github.workspace }}
          /tmp/flutter_ohos/bin/flutter pub get

      - name: Build Flutter for OHOS
        run: |
          cd ${{ github.workspace }}
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          /tmp/flutter_ohos/bin/flutter build ohos --${BUILD_TYPE} || true

      - name: Extract Flutter engine native libraries
        run: |
          # Download engine if needed
          /tmp/flutter_ohos/bin/flutter precache || true

          ENGINE_DIR="/tmp/flutter_ohos/bin/cache/artifacts/engine/ohos-arm64"
          LIBS_DIR="${{ github.workspace }}/ohos/entry/libs/arm64-v8a"

          mkdir -p "$LIBS_DIR"
          mkdir -p /tmp/har_extract
          cd /tmp/har_extract

          # Extract HAR (gzip + tar format)
          if [ -f "$ENGINE_DIR/flutter.har" ]; then
            gunzip -c "$ENGINE_DIR/flutter.har" > flutter.tar 2>/dev/null || \
              cp "$ENGINE_DIR/flutter.har" flutter.tar

            tar -xf flutter.tar 2>/dev/null || true

            if [ -d "package/libs/arm64-v8a" ]; then
              cp package/libs/arm64-v8a/*.so "$LIBS_DIR/"
              echo "Native libraries extracted:"
              ls -la "$LIBS_DIR"
            fi
          fi

      - name: Build unsigned HAP
        run: |
          cd ${{ github.workspace }}
          chmod +x ohos/build_hap.sh

          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          if [ "$BUILD_TYPE" = "release" ]; then
            ./ohos/build_hap.sh --release
          else
            ./ohos/build_hap.sh
          fi

      - name: Upload HAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: ohos-hap-${{ github.event.inputs.build_type || 'debug' }}
          path: |
            ${{ github.workspace }}/ohos/entry/build/default/outputs/default/*.hap
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** https://cnb.cool/wget/i/synclipboard" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.event.inputs.branch || 'ohos' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** ${{ github.event.inputs.build_type || 'debug' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Working Dir:** ${{ github.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter OHOS:** ${{ env.FLUTTER_OHOS_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh ${{ github.workspace }}/ohos/entry/build/default/outputs/default/*.hap 2>/dev/null || echo "No HAP file generated"
          echo '```' >> $GITHUB_STEP_SUMMARY
