name: Build OHOS HAP

on:
  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  FLUTTER_VERSION: '3.22.0'

jobs:
  build-hap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 克隆指定仓库的 ohos2 分支到 synclipboard 目录
      - name: Clone synclipboard (ohos2 branch)
        run: |
          rm -rf synclipboard
          git clone -b ohos2 https://cnb.cool/wget/i/synclipboard synclipboard
          if [ ! -d "synclipboard" ]; then
            echo "Failed to clone synclipboard repository"
            exit 1
          fi
          echo "Successfully cloned synclipboard (ohos2 branch)"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter (适配 3.22.0 版本)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install system dependencies
        run: |
          # 安装 Flutter 构建 OHOS 所需的基础依赖
          sudo apt update && sudo apt install -y \
            unzip zip curl git \
            lib32z1 lib32stdc++6 \
            nodejs npm
          # 验证基础环境
          flutter --version
          java -version
          node -v

      - name: Configure Flutter for OHOS (适配 3.22.0)
        run: |
          # Flutter 3.22.0 仅支持 --enable-ohos 参数，没有 desktop 后缀
          flutter config --enable-ohos
          # 验证 Flutter 配置
          flutter config
          flutter doctor -v

      - name: Prepare Flutter project
        working-directory: synclipboard
        run: |
          # 安装项目依赖
          flutter pub get
          # 确保 OHOS 模块存在（如果不存在则创建）
          if [ ! -d "ohos" ]; then
            echo "Generating OHOS project files..."
            flutter create --platforms=ohos .
          fi
          # 修复可能的权限问题
          chmod -R 755 .

      - name: Build OHOS HAP (核心构建步骤)
        working-directory: synclipboard
        run: |
          # 选择构建类型（Debug/Release）
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          echo "Building OHOS HAP (${BUILD_TYPE})..."
          
          # 核心构建命令（适配 Flutter 3.22.0）
          if [ "$BUILD_TYPE" = "release" ]; then
            flutter build hap --release --verbose
          else
            flutter build hap --debug --verbose
          fi

      - name: Locate HAP files (容错版)
        id: find_hap
        working-directory: synclipboard
        run: |
          # 扩大搜索范围，兼容不同的输出路径
          HAP_FILES=$(find . -name "*.hap" -type f | grep -E "build|ohos/outputs")
          if [ -n "$HAP_FILES" ]; then
            # 取第一个 HAP 文件
            HAP_FILE=$(echo "$HAP_FILES" | head -n 1)
            echo "hap_path=$HAP_FILE" >> $GITHUB_OUTPUT
            echo "hap_name=$(basename $HAP_FILE)" >> $GITHUB_OUTPUT
            echo "Found HAP files:"
            echo "$HAP_FILES"
          else
            echo "WARNING: No HAP file found, listing possible directories:"
            # 列出所有可能的输出目录，帮助调试
            ls -la build/ || true
            ls -la ohos/ || true
            ls -la ohos/outputs/ || true
            # 不中断流程，仅警告
            echo "hap_path=none" >> $GITHUB_OUTPUT
            echo "hap_name=none" >> $GITHUB_OUTPUT
          fi

      - name: Upload HAP artifact (仅当找到文件时)
        if: steps.find_hap.outputs.hap_path != 'none'
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-${{ github.event.inputs.build_type || 'debug' }}
          path: synclipboard/${{ steps.find_hap.outputs.hap_path }}
          retention-days: 30

      - name: Create Release (仅 Release 构建且手动触发)
        if: github.event.inputs.build_type == 'release' && github.event_name == 'workflow_dispatch' && steps.find_hap.outputs.hap_path != 'none'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          files: synclipboard/${{ steps.find_hap.outputs.hap_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 简化版构建（自托管 runner 备用）
  build-hap-simple:
    runs-on: self-hosted
    if: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone synclipboard (ohos2 branch)
        run: |
          rm -rf synclipboard
          git clone -b ohos2 https://cnb.cool/wget/i/synclipboard synclipboard
          if [ ! -d "synclipboard" ]; then
            exit 1
          fi

      - name: Build HAP (简化版)
        working-directory: synclipboard
        run: |
          flutter pub get
          flutter build hap --release

      - name: Upload HAP
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-release
          path: |
            synclipboard/build/ohos/outputs/*.hap
            synclipboard/ohos/outputs/*.hap
