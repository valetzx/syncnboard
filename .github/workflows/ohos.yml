name: Build HarmonyOS (OHOS)

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  OHOS_SDK_VERSION: "12"
  BUNDLE_NAME: "cool.cnb.syncnboard"
  OHOS_REPO_URL: "https://cnb.cool/wget/i/synclipboard"
  OHOS_BRANCH: "ohos"

jobs:
  build-ohos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clone OHOS project from external repository
        run: |
          git clone -b ${{ env.OHOS_BRANCH }} ${{ env.OHOS_REPO_URL }} ohos-project
          echo "OHOS_PROJECT_PATH=$GITHUB_WORKSPACE/ohos-project" >> $GITHUB_ENV
          ls -la $GITHUB_WORKSPACE/ohos-project

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup OHPM (OpenHarmony Package Manager)
        run: |
          curl -L "https://repo.harmonyos.com/npm/ohpm-cli-1.5.2.tgz" -o ohpm-cli.tgz
          tar -xzf ohpm-cli.tgz
        
          sudo cp -r package/bin/ohpm /usr/local/bin/
          sudo cp -r package/lib/node_modules/@ohos /usr/local/lib/node_modules/ 2>/dev/null || true

          ohpm --version || echo "OHPM installed"

          echo "OHPM_CACHE=$HOME/.ohpm" >> $GITHUB_ENV

      - name: Cache OHPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.ohpm
            **/oh_modules
          key: ${{ runner.os }}-ohpm-${{ hashFiles('**/oh-package.json5') }}
          restore-keys: |
            ${{ runner.os }}-ohpm-

      - name: Setup Hvigor build tool
        run: |
          npm install -g @ohos/hvigor
          hvigor --version || echo "Hvigor installed"

      - name: Download HarmonyOS SDK
        run: |
          mkdir -p $HOME/ohos-sdk

          curl -L "https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_9_16/e2/r3/609126a99d6441f4a80c16fa9ad993d5/ao1ZesO8Rk2Lx3sWvYHyyQ/command-line-tools-linux-x64-5.0.5.401.zip" -o cmdline-tools.zip || true
          
          if [ -f cmdline-tools.zip ]; then
            unzip -q cmdline-tools.zip -d $HOME/ohos-sdk 2>/dev/null || echo "SDK extracted with warnings"
          fi

          echo "OHOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "OHOS_SDK_ROOT=$HOME/ohos-sdk" >> $GITHUB_ENV
          echo "HARMONYOS_SDK_HOME=$HOME/ohos-sdk" >> $GITHUB_ENV

          echo "$HOME/ohos-sdk/toolchains" >> $GITHUB_PATH
          echo "$HOME/ohos-sdk/openharmony/toolchains" >> $GITHUB_PATH 2>/dev/null || true

      - name: Create local.properties
        run: |
          cd ${{ env.OHOS_PROJECT_PATH }}/ohos
          cat > local.properties << EOF
          sdk.dir=$HOME/ohos-sdk
          ohos.sdk.dir=$HOME/ohos-sdk
          nodejs.dir=$(which node | xargs dirname)
          EOF

      - name: Install OHOS project dependencies
        run: |
          cd ${{ env.OHOS_PROJECT_PATH }}/ohos
          ohpm config set registry https://repo.harmonyos.com/npm/
          ohpm install --all

      - name: Build HAP (HarmonyOS Ability Package)
        run: |
          cd ${{ env.OHOS_PROJECT_PATH }}/ohos
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          
          echo "Building HAP with mode: $BUILD_TYPE"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor clean
            hvigor assembleHap --no-daemon -p product=default -p buildMode=release
          else
            hvigor clean
            hvigor assembleHap --no-daemon -p product=default -p buildMode=debug
          fi

      - name: Build APP (HarmonyOS Application Package)
        run: |
          cd ${{ env.OHOS_PROJECT_PATH }}/ohos
          
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          
          echo "Building APP with mode: $BUILD_TYPE"
          
          if [ "$BUILD_TYPE" = "release" ]; then
            hvigor assembleApp --no-daemon -p product=default -p buildMode=release
          else
            hvigor assembleApp --no-daemon -p product=default -p buildMode=debug
          fi

      - name: List build outputs
        run: |
          echo "=== Build Outputs ==="
          echo "--- HAP files ---"
          find ${{ env.OHOS_PROJECT_PATH }}/ohos -name "*.hap" 2>/dev/null || echo "No HAP files found"
          
          echo ""
          echo "--- APP files ---"
          find ${{ env.OHOS_PROJECT_PATH }}/ohos -name "*.app" 2>/dev/null || echo "No APP files found"
          
          echo ""
          echo "--- Entry output directory ---"
          ls -la ${{ env.OHOS_PROJECT_PATH }}/ohos/entry/build/default/outputs/default/ 2>/dev/null || echo "Entry output not found"

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/hap
          mkdir -p artifacts/app

          find ${{ env.OHOS_PROJECT_PATH }}/ohos -name "*.hap" -exec cp {} artifacts/hap/ \; 2>/dev/null || true
          
          find ${{ env.OHOS_PROJECT_PATH }}/ohos -name "*.app" -exec cp {} artifacts/app/ \; 2>/dev/null || true

          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          VERSION="${{ github.ref_name }}"
          
          if [ -f artifacts/hap/*.hap ]; then
            for f in artifacts/hap/*.hap; do
              mv "$f" "artifacts/hap/syncnboard-${VERSION}-${BUILD_TYPE}.hap" 2>/dev/null || true
            done
          fi

      - name: Upload HAP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-hap-${{ github.event.inputs.build_type || 'debug' }}
          path: artifacts/hap/*.hap
          retention-days: 30
          if-no-files-found: warn

      - name: Upload APP artifact
        uses: actions/upload-artifact@v4
        with:
          name: syncnboard-ohos-app-${{ github.event.inputs.build_type || 'debug' }}
          path: artifacts/app/*.app
          retention-days: 30
          if-no-files-found: warn

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/hap/*.hap
            artifacts/app/*.app
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
